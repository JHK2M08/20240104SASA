<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공지사항</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* 스타일 코드 (변경 없음) */
    </style>
</head>
<body>
    <header>
        <h1>공지사항</h1>
        <nav>
            <ul>
                <li><a href="index.html">홈</a></li>
                <li><a href="assignments.html">일정표 및 기타 사항</a></li>
                <li><a href="notices.html">공지사항</a></li>
            </ul>
        </nav>
    </header>
    <div class="content">
        <button id="homeBtn" onclick="window.location.href='index.html';">홈</button>
        <h2>공지사항</h2>
        <input type="text" id="titleInput" placeholder="제목을 입력하세요...">
        <textarea id="contentInput" rows="4" placeholder="내용을 입력하세요..."></textarea>
        <button id="addNoticeBtn">추가</button>
        <ul id="noticeList"></ul>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', loadNotices);

        document.getElementById('titleInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        document.getElementById('contentInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        document.getElementById('addNoticeBtn').onclick = async function() {
            const titleInput = document.getElementById('titleInput');
            const contentInput = document.getElementById('contentInput');
            const titleText = titleInput.value.trim();
            const contentText = contentInput.value.trim();

            if (titleText !== '' && contentText !== '') {
                const noticeDateTime = new Date().toLocaleString(); // 현재 날짜와 시간
                await saveNotice(titleText, contentText, noticeDateTime);
                titleInput.value = '';
                contentInput.value = '';
                titleInput.style.height = 'auto';
                contentInput.style.height = 'auto';
                loadNotices(); // 공지사항 목록 새로 고침
            } else {
                alert('제목과 내용을 입력하세요.');
            }
        };

        async function createNoticeItem(titleText, contentText, dateTime, pinned = false) {
            const noticeItem = document.createElement('li');
            noticeItem.className = 'noticeItem';
            noticeItem.innerHTML = `
                <h3>${titleText}</h3>
                <div class="dateTime">${dateTime}</div>
                <p>${contentText}</p>
                <div class="buttonContainer">
                    <button class="pinBtn">${pinned ? '고정 해제' : '고정'}</button>
                    <button class="editBtn">수정</button>
                    <button class="deleteBtn">삭제</button>
                </div>
            `;

            noticeItem.querySelector('.deleteBtn').onclick = async function() {
                await deleteNotice(titleText, contentText);
                noticeItem.remove();
            };

            noticeItem.querySelector('.editBtn').onclick = function() {
                editNotice(noticeItem, titleText, contentText);
            };

            noticeItem.querySelector('.pinBtn').onclick = async function() {
                if (pinned) {
                    noticeItem.querySelector('.pinBtn').innerText = '고정';
                    noticeItem.classList.remove('pinned');
                    await pinNotice(titleText, contentText, false);
                } else {
                    noticeItem.querySelector('.pinBtn').innerText = '고정 해제';
                    noticeItem.classList.add('pinned');
                    await pinNotice(titleText, contentText, true);
                }
            };

            return noticeItem;
        }

        async function saveNotice(titleText, contentText, dateTime, pinned = false) {
            await fetch('http://localhost:3000/store', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title: titleText, content: contentText, dateTime: dateTime, pinned: pinned }),
            });
        }

        async function deleteNotice(titleText, contentText) {
            await fetch('http://localhost:3000/delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title: titleText, content: contentText }),
            });
        }

        async function pinNotice(titleText, contentText, pinned) {
            await fetch('http://localhost:3000/pin', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ title: titleText, content: contentText, pinned: pinned }),
            });
        }

        async function loadNotices() {
            const response = await fetch('http://localhost:3000/retrieve');
            const notices = await response.json();
            const noticeList = document.getElementById('noticeList');
            noticeList.innerHTML = '';

            notices.forEach(notice => {
                const noticeItem = createNoticeItem(notice.title, notice.content, notice.dateTime, notice.pinned);
                noticeList.appendChild(noticeItem);
            });
        }

        function editNotice(noticeItem, oldTitle, oldContent) {
            const titleInput = document.getElementById('titleInput');
            const contentInput = document.getElementById('contentInput');

            titleInput.value = oldTitle;
            contentInput.value = oldContent;
            titleInput.style.height = 'auto';
            contentInput.style.height = 'auto';

            noticeItem.remove();
            deleteNotice(oldTitle, oldContent);
        }
    </script>
</body>
</html>
